name: CRD_Linux_Remote_Access

on:
  workflow_dispatch:

jobs:
  setup-linux-crd:
    runs-on: ubuntu-latest
    timeout-minutes: 2000

    steps:
      - name: üß© System Info
        run: |
          echo "=== üêß Linux Environment Info ==="
          cat /etc/os-release
          uname -a
          echo "================================="

      - name: üì¶ Install XFCE + Chrome Remote Desktop
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-goodies dbus-x11 x11-xserver-utils wget curl sudo
          wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo apt install -y ./chrome-remote-desktop_current_amd64.deb
          rm chrome-remote-desktop_current_amd64.deb
          echo "‚úÖ CRD installed!"

      - name: üë§ Create Remote User
        run: |
          sudo useradd -m remoteuser || true
          PASSWORD=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 8)
          echo "remoteuser:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo remoteuser
          echo "CRD_PASS=$PASSWORD" >> $GITHUB_ENV
          echo "‚úÖ User created: remoteuser / $PASSWORD"

      - name: üß† Setup Chrome Remote Desktop
        env:
          CRD_AUTH_CODE: ${{ secrets.CRD_AUTH_CODE }}
        run: |
          if [ -z "$CRD_AUTH_CODE" ]; then
            echo "‚ùå Missing CRD_AUTH_CODE secret!"
            exit 1
          fi
          PIN=$(shuf -i 100000-999999 -n 1)
          echo "CRD_PIN=$PIN" >> $GITHUB_ENV
          sudo groupadd chrome-remote-desktop || true
          sudo usermod -aG chrome-remote-desktop remoteuser
          sudo -u remoteuser bash -c "echo xfce4-session > ~/.chrome-remote-desktop-session"
          DISPLAY= /opt/google/chrome-remote-desktop/start-host \
            --code="$CRD_AUTH_CODE" \
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
            --name="GitHub-Linux-${{ github.run_id }}" \
            --pin="$PIN" &
          echo "‚úÖ CRD linked successfully! PIN: $PIN"

      - name: üìã Connection Info
        run: |
          echo "=============================================="
          echo "üêß Chrome Remote Desktop for Linux Ready!"
          echo "User     : remoteuser"
          echo "Password : $CRD_PASS"
          echo "PIN      : $CRD_PIN"
          echo "Access   : https://remotedesktop.google.com/access"
          echo "=============================================="

      - name: üí§ Keep Alive
        run: |
          while true; do
            echo "[$(date)] üü¢ Linux CRD session active..."
            sleep 300
          done
