name: CRD_macOS_Remote_Access

on:
  workflow_dispatch:

jobs:
  setup-macos-crd:
    runs-on: macos-latest
    timeout-minutes: 2000

    steps:
      - name: üçè System Info
        run: |
          echo "=== üçé macOS Environment Info ==="
          sw_vers
          uname -a
          echo "================================="

      - name: üì¶ Install Chrome Remote Desktop
        run: |
          set -e
          echo "üì¶ Downloading Chrome Remote Desktop DMG..."
          curl -L -o /tmp/chromeremotedesktop.dmg "https://dl.google.com/dl/chrome-remote-desktop/chromeremotedesktop.dmg"

          echo "üíø Mounting DMG..."
          # Menggunakan hdiutil JSON output untuk mendapatkan mount point secara aman
          MOUNT_POINT=$(hdiutil attach /tmp/chromeremotedesktop.dmg -nobrowse -plist | \
            plutil -extract system-entities xml1 -o - - | \
            grep -A1 '<key>mount-point</key>' | grep '<string>' | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | head -n 1)
          
          if [ -z "$MOUNT_POINT" ]; then
            echo "‚ùå Gagal mendapatkan mount point."
            exit 1
          fi

          echo "üìÄ Mounted at: $MOUNT_POINT"

          # Cari dan install .pkg
          PKG_FILE=$(find "$MOUNT_POINT" -maxdepth 1 -name "*.pkg" | head -n 1)
          
          if [ -n "$PKG_FILE" ]; then
            echo "üì¶ Found PKG installer: $PKG_FILE"
            sudo installer -pkg "$PKG_FILE" -target /
          else
            echo "‚ùå Tidak ditemukan file .pkg di dalam DMG!"
            ls -R "$MOUNT_POINT"
            exit 1
          fi

          echo "üíæ Unmounting..."
          hdiutil detach "$MOUNT_POINT"
          rm /tmp/chromeremotedesktop.dmg
          echo "‚úÖ Chrome Remote Desktop installed successfully!"

      - name: üë§ Create Remote User
        run: |
          # Perlu diketahui: Membuat user di macOS runner kadang-kadang menyebabkan masalah akses
          # Untuk CRD, ini mungkin tidak diperlukan jika Anda hanya ingin akses ke desktop runner,
          # tapi kita pertahankan agar Anda bisa login dengan user terpisah.
          USERNAME="remoteuser"
          # Pastikan password hanya terdiri dari huruf/angka sederhana
          PASSWORD=$(LC_ALL=C tr -dc A-Za-z0-9 </dev/urandom | head -c 10) 
          sudo sysadminctl -addUser "$USERNAME" -password "$PASSWORD" -fullName "$USERNAME" -home /Users/"$USERNAME" -shell /bin/bash
          # Tambahkan ke grup admin
          sudo dscl . -append /Groups/admin GroupMembership "$USERNAME" || true
          
          echo "CRD_USER=$USERNAME" >> $GITHUB_ENV
          echo "CRD_PASS=$PASSWORD" >> $GITHUB_ENV
          echo "‚úÖ Created user $USERNAME / $PASSWORD"

      - name: üß† Setup Chrome Remote Desktop (Dinamis)
        env:
          CRD_AUTH_CODE: ${{ secrets.CRD_AUTH_CODE }}
        run: |
          if [ -z "$CRD_AUTH_CODE" ]; then
            echo "‚ùå Missing CRD_AUTH_CODE secret!"
            echo "Generate it from: https://remotedesktop.google.com/headless"
            exit 1
          fi

          PIN=$(jot -r 1 100000 999999)
          echo "CRD_PIN=$PIN" >> $GITHUB_ENV
          
          # FIX: Temukan binary secara dinamis di dalam folder Applications
          # Nama binary host yang sebenarnya adalah 'remoting' atau 'Chrome Remote Desktop Host'
          BIN=$(find /Applications -type f -name "Chrome Remote Desktop Host" -perm +111 -print -quit)

          if [ -z "$BIN" ]; then
            echo "‚ùå CRD Host executable binary not found in /Applications!"
            echo "Listing potential paths for debug:"
            ls -R /Applications | grep -i 'chrome' || true
            exit 1
          fi

          echo "‚úÖ Found CRD Host Binary at: $BIN"

          # Jalankan setup CRD
          sudo "$BIN" \
            --code="$CRD_AUTH_CODE" \
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
            --name="GitHub-macOS-${{ github.run_id }}" \
            --pin="$PIN" &
          
          # Beri waktu sebentar untuk proses pendaftaran berjalan
          sleep 5
          echo "‚úÖ CRD link initiated! PIN: $PIN"

      - name: üìã Connection Info
        run: |
          echo "=============================================="
          echo "üçè Chrome Remote Desktop for macOS Ready!"
          echo "User     : $CRD_USER"
          echo "Password : $CRD_PASS"
          echo "PIN      : $CRD_PIN"
          echo "Access   : https://remotedesktop.google.com/access"
          echo "=============================================="

      - name: üí§ Keep Alive
        run: |
          while true; do
            echo "[$(date)] üü¢ macOS CRD session active..."
            sleep 300
          done
