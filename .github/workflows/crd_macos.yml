name: CRD_macOS_Remote_Access

on:
  workflow_dispatch:

jobs:
  setup-macos-crd:
    runs-on: macos-latest
    timeout-minutes: 2000

    steps:
      - name: üçè System Info
        run: |
          echo "=== üçé macOS Environment Info ==="
          sw_vers
          uname -a
          echo "================================="

      - name: üì¶ Install Chrome Remote Desktop Host (via Homebrew Cask)
        run: |
          echo "üì¶ Installing Chrome Remote Desktop Host via Homebrew Cask..."
          # Menggunakan Homebrew untuk instalasi yang stabil di lingkungan CI
          brew install --cask chrome-remote-desktop-host
          echo "‚úÖ Chrome Remote Desktop Host installed successfully!"

      - name: üë§ Generate Credentials
        run: |
          # Generate credentials tanpa membuat user baru (untuk menghindari hang)
          USERNAME="gh-actions-$(date +%s)"
          # Pastikan password hanya terdiri dari huruf/angka sederhana
          PASSWORD=$(openssl rand -base64 12 | tr -d '/+' | cut -c1-10)
          
          echo "CRD_USER=$USERNAME" >> $GITHUB_ENV
          echo "CRD_PASS=$PASSWORD" >> $GITHUB_ENV
          echo "‚úÖ Generated credentials: Username=$USERNAME, Password=$PASSWORD"

      - name: üß† Setup Chrome Remote Desktop
        env:
          CRD_AUTH_CODE: ${{ secrets.CRD_AUTH_CODE }}
        run: |
          if [ -z "$CRD_AUTH_CODE" ]; then
            echo "‚ùå Missing CRD_AUTH_CODE secret!"
            echo "Generate it from: https://remotedesktop.google.com/headless"
            exit 1
          fi

          PIN=$(jot -r 1 100000 999999)
          echo "CRD_PIN=$PIN" >> $GITHUB_ENV
          
          echo "üîß Setting up Chrome Remote Desktop..."
          
          # FIX: Cari binary executable CRD Host secara dinamis. 
          # Homebrew menginstal aplikasi ke /Applications
          BIN_PATH=$(find /Applications -type f -name "Chrome Remote Desktop Host" -perm +111 -print -quit)

          if [ -z "$BIN_PATH" ]; then
            echo "‚ùå CRD Host executable binary not found!"
            echo "Listing potential apps for debug:"
            ls -R /Applications | grep -i 'chrome remote' || true
            exit 1
          fi

          echo "‚úÖ Found CRD Host Binary at: $BIN_PATH"
          
          # Jalankan setup CRD
          sudo "$BIN_PATH" \
            --code="$CRD_AUTH_CODE" \
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
            --name="GitHub-macOS-${{ github.run_id }}" \
            --pin="$PIN" &

          CRD_PID=$!
          echo "CRD_PID=$CRD_PID" >> $GITHUB_ENV
          
          # Tunggu proses mulai
          sleep 15
          
          # Cek apakah proses masih berjalan
          if kill -0 $CRD_PID 2>/dev/null; then
            echo "‚úÖ CRD setup completed successfully! PID: $CRD_PID"
          else
            echo "‚ö†Ô∏è CRD process may have exited. Check CRD_AUTH_CODE and permissions."
            ps aux | grep chrome-remote-desktop || true
          fi

      - name: üìã Connection Info
        run: |
          echo "=============================================="
          echo "üçè Chrome Remote Desktop for macOS Ready!"
          echo "User     : $CRD_USER"
          echo "Password : $CRD_PASS" 
          echo "PIN      : $CRD_PIN"
          echo "Access   : https://remotedesktop.google.com/access"
          echo "Run ID   : ${{ github.run_id }}"
          echo "=============================================="

      - name: üîç Check CRD Status
        run: |
          echo "üîç Checking Chrome Remote Desktop status..."
          ps aux | grep -i chrome-remote-desktop || echo "No CRD processes found"
          system_profiler SPApplicationsDataType | grep -i "chrome remote" || true

      - name: üí§ Keep Alive
        run: |
          echo "üîÑ Starting keep-alive loop..."
          COUNTER=0
          while [ $COUNTER -lt 240 ]; do  # 240 * 30s = 2 hours (sesuai timeout)
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] üü¢ macOS CRD session active... ($((COUNTER * 30 / 60)) minutes)"
            # Cek apakah CRD process masih berjalan
            if ps aux | grep -v grep | grep -q "Chrome Remote Desktop Host"; then
              echo "   ‚úÖ CRD process is running"
            else
              echo "   ‚ö†Ô∏è CRD process not found, session may have ended"
            fi
            sleep 30
            COUNTER=$((COUNTER + 1))
          done
          echo "‚è∞ Timeout reached, ending workflow"
