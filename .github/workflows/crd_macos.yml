name: CRD_macOS_Remote_Access

on:
  workflow_dispatch:

jobs:
  setup-macos-crd:
    runs-on: macos-latest
    timeout-minutes: 2000

    steps:
      - name: üçè System Info
        run: |
          echo "=== üçé macOS Environment Info ==="
          sw_vers
          uname -a
          echo "================================="

      - name: üì¶ Install Chrome Remote Desktop (Via DMG Installer)
        run: |
          set -e
          echo "üì¶ Downloading Chrome Remote Desktop DMG..."
          # Menggunakan URL unduhan langsung resmi
          curl -L -o /tmp/chromeremotedesktop.dmg "https://dl.google.com/dl/chrome-remote-desktop/chromeremotedesktop.dmg"

          echo "üíø Mounting DMG..."
          hdiutil attach /tmp/chromeremotedesktop.dmg -nobrowse -quiet
          MOUNT_POINT=$(ls -d /Volumes/Chrome\ Remote\ Desktop* 2>/dev/null | head -n1)
          
          if [ -z "$MOUNT_POINT" ]; then
            echo "‚ùå Gagal mendapatkan mount point."
            exit 1
          fi

          echo "üìÄ Mounted at: $MOUNT_POINT"

          # Cari dan install .pkg
          PKG_FILE=$(find "$MOUNT_POINT" -name "*.pkg" -maxdepth 1 | head -n1)
          
          if [ -n "$PKG_FILE" ]; then
            echo "üì¶ Found PKG installer: $PKG_FILE"
            # Instal ke root path /Applications
            sudo installer -pkg "$PKG_FILE" -target / -allowUntrusted
          else
            echo "‚ùå Tidak ditemukan file .pkg di dalam DMG!"
            ls -la "$MOUNT_POINT"
            exit 1
          fi

          echo "üíæ Unmounting..."
          hdiutil detach "$MOUNT_POINT" -quiet
          rm -f /tmp/chromeremotedesktop.dmg
          echo "‚úÖ Chrome Remote Desktop installed successfully!"

      - name: üë§ Generate Credentials
        run: |
          # Generate credentials tanpa membuat user baru (untuk menghindari hang)
          USERNAME="gh-actions-$(date +%s)"
          # Pastikan password hanya terdiri dari huruf/angka sederhana
          PASSWORD=$(openssl rand -base64 12 | tr -d '/+' | cut -c1-10)
          
          echo "CRD_USER=$USERNAME" >> $GITHUB_ENV
          echo "CRD_PASS=$PASSWORD" >> $GITHUB_ENV
          echo "‚úÖ Generated credentials: Username=$USERNAME, Password=$PASSWORD"

      - name: üß† Setup Chrome Remote Desktop
        env:
          CRD_AUTH_CODE: ${{ secrets.CRD_AUTH_CODE }}
        run: |
          if [ -z "$CRD_AUTH_CODE" ]; then
            echo "‚ùå Missing CRD_AUTH_CODE secret!"
            echo "Generate it from: https://remotedesktop.google.com/headless"
            exit 1
          fi

          PIN=$(jot -r 1 100000 999999)
          echo "CRD_PIN=$PIN" >> $GITHUB_ENV
          
          echo "üîß Setting up Chrome Remote Desktop..."
          
          # Pencarian binary yang paling agresif di dalam /Applications
          # Mencari file executable biner host CRD, yang biasanya adalah 'remoting_host'
          # atau 'Chrome Remote Desktop Host'
          BIN_PATH=$(find /Applications -type f -perm +111 \( -name "*remoting_host*" -o -name "*Chrome Remote Desktop Host*" \) -print -quit)

          if [ -z "$BIN_PATH" ]; then
            echo "‚ùå CRD Host executable binary not found!"
            echo "Listing files in /Applications/ for debug:"
            ls -R /Applications | grep -i 'chrome remote' || true
            exit 1
          fi

          echo "‚úÖ Found CRD Host Binary at: $BIN_PATH"
          
          # Jalankan setup CRD
          # Menggunakan path lengkap yang ditemukan oleh find
          sudo "$BIN_PATH" \
            --code="$CRD_AUTH_CODE" \
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
            --name="GitHub-macOS-${{ github.run_id }}" \
            --pin="$PIN" &

          CRD_PID=$!
          echo "CRD_PID=$CRD_PID" >> $GITHUB_ENV
          
          # Tunggu proses mulai
          sleep 15
          
          # Cek apakah proses masih berjalan
          if kill -0 $CRD_PID 2>/dev/null; then
            echo "‚úÖ CRD setup completed successfully! PID: $CRD_PID"
          else
            echo "‚ö†Ô∏è CRD process may have exited. Check CRD_AUTH_CODE and permissions."
            ps aux | grep "Chrome Remote Desktop" || true
          fi

      - name: üìã Connection Info
        run: |
          echo "=============================================="
          echo "üçè Chrome Remote Desktop for macOS Ready!"
          echo "User     : $CRD_USER"
          echo "Password : $CRD_PASS" 
          echo "PIN      : $CRD_PIN"
          echo "Access   : https://remotedesktop.google.com/access"
          echo "Run ID   : ${{ github.run_id }}"
          echo "=============================================="

      - name: üîç Check CRD Status
        run: |
          echo "üîç Checking Chrome Remote Desktop status..."
          ps aux | grep -i "Chrome Remote Desktop" || echo "No CRD processes found"
          system_profiler SPApplicationsDataType | grep -i "chrome remote" || true

      - name: üí§ Keep Alive
        run: |
          echo "üîÑ Starting keep-alive loop..."
          COUNTER=0
          while [ $COUNTER -lt 240 ]; do  # 240 * 30s = 2 hours (sesuai timeout)
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] üü¢ macOS CRD session active... ($((COUNTER * 30 / 60)) minutes)"
            # Cek apakah CRD process masih berjalan
            if ps aux | grep -v grep | grep -q "Chrome Remote Desktop Host"; then
              echo "   ‚úÖ CRD process is running"
            else
              echo "   ‚ö†Ô∏è CRD process not found, session may have ended"
            fi
            sleep 30
            COUNTER=$((COUNTER + 1))
          done
          echo "‚è∞ Timeout reached, ending workflow"
