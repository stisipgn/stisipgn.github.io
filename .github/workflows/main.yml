name: Linux_GUI_Remote

on:
  workflow_dispatch:  # bisa dijalankan manual dari tab Actions

jobs:
  linux-vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 2000  # sekitar 33 jam maksimum aktif

    steps:
      - name: System Info
        run: |
          echo "=== ğŸ§ System Info ==="
          lsb_release -a || cat /etc/os-release
          uname -a
          df -h
          echo "====================="

      # ğŸ§© Install desktop + VNC + Tailscale
      - name: Install XFCE, VNC, and Tailscale
        run: |
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies tightvncserver curl

          echo "â¬‡ï¸ Installing Tailscale..."
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update
          sudo apt-get install -y tailscale
          echo "âœ… Installation complete!"

      # ğŸ‘¤ Create VNC User
      - name: Setup VNC User
        run: |
          echo "ğŸ‘¤ Creating VNC user..."
          sudo useradd -m vncuser || true
          
          # âœ… generate alphanumeric password (8 chars)
          PASSWORD=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 8)
          echo "vncuser:$PASSWORD" | sudo chpasswd
          echo "VNC_USER=vncuser" >> $GITHUB_ENV
          echo "VNC_PASS=$PASSWORD" >> $GITHUB_ENV

          echo "ğŸ“ Setting up VNC configuration..."
          sudo -u vncuser mkdir -p /home/vncuser/.vnc
          echo "xfce4-session &" | sudo tee /home/vncuser/.vnc/xstartup > /dev/null
          sudo chmod +x /home/vncuser/.vnc/xstartup

          # âœ… Set VNC password file (no prompt)
          echo "$PASSWORD" | vncpasswd -f | sudo tee /home/vncuser/.vnc/passwd > /dev/null
          sudo chmod 600 /home/vncuser/.vnc/passwd
          sudo chown -R vncuser:vncuser /home/vncuser/.vnc

          echo "âœ… VNC user created and password set."

      # ğŸ§  Start Tailscale
      - name: Start and Connect Tailscale
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          echo "ğŸš€ Starting Tailscale..."
          sudo tailscaled & sleep 3
          sudo tailscale up --authkey=${TS_AUTHKEY} --hostname=linux-vnc-${{ github.run_id }} --accept-dns=false
          TS_IP=$(sudo tailscale ip -4 | head -n1)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "âœ… Tailscale connected at $TS_IP"

      # ğŸ–¥ï¸ Start VNC Server
      - name: Start VNC Server
        run: |
          echo "ğŸ–¥ï¸ Starting VNC server for user $VNC_USER..."
          sudo -u vncuser vncserver :1 -geometry 1280x800 -depth 24
          echo "âœ… VNC running on port 5901"

      # ğŸ”¥ Firewall (optional but safe)
      - name: Configure Firewall for VNC
        run: |
          sudo ufw allow 5901/tcp
          sudo ufw allow 22/tcp
          sudo ufw reload || true
          echo "âœ… Firewall configured."

      # âœ… Show connection info
      - name: Display Access Info
        run: |
          echo "=============================================="
          echo "ğŸ‰ Linux GUI Remote Ready via Tailscale"
          echo "ğŸ”— Connect with any VNC client using:"
          echo "    Address : $TAILSCALE_IP:5901"
          echo "    Username: $VNC_USER"
          echo "    Password: $VNC_PASS"
          echo "----------------------------------------------"
          echo "ğŸ’¡ On Windows: use RealVNC / TightVNC"
          echo "ğŸ’¡ On Linux  : use Remmina / Vinagre"
          echo "ğŸ’¡ On macOS  : Finder â†’ Go â†’ Connect to Server â†’ vnc://$TAILSCALE_IP:5901"
          echo "=============================================="

      # ğŸ’¤ Keep alive
      - name: Keep Session Alive
        run: |
          while true; do
            echo "[$(date)] ğŸŸ¢ Linux GUI via VNC alive at $TAILSCALE_IP:5901"
            sleep 300
          done
