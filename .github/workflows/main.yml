name: VNC_TIPSUNIX

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Install TightVNC
        run: |
          $url = "https://www.tightvnc.com/download/2.8.81/tightvnc-2.8.81-gpl-setup-64bit.msi"
          $file = "$env:TEMP\tightvnc.msi"
          Invoke-WebRequest -Uri $url -OutFile $file

          # Generate VNC password (8 chars)
          Add-Type -AssemblyName System.Security
          $chars = ([char[]](33..126))
          $vncPass = -join (1..8 | ForEach-Object { $chars | Get-Random })
          $encPass = ([System.Text.Encoding]::UTF8.GetBytes($vncPass))

          echo "VNC_PASS=$vncPass" >> $env:GITHUB_ENV

          # Install TightVNC silently with password
          Start-Process msiexec.exe -ArgumentList "/i `"$file`" ADDLOCAL=Server /quiet /norestart" -Wait

          # Apply authentication password
          $regPath = "HKLM:\Software\TightVNC\Server"
          New-Item -Path $regPath -Force | Out-Null
          Set-ItemProperty -Path $regPath -Name "Password" -Value $encPass

          # Allow 5900 in firewall
          netsh advfirewall firewall delete rule name="TightVNC"
          netsh advfirewall firewall add rule name="TightVNC" dir=in action=allow protocol=TCP localport=5900

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installer = "$env:TEMP\ts.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installer
          Start-Process msiexec.exe -ArgumentList "/i `"$installer`" /quiet /norestart" -Wait

      - name: Connect to Tailscale
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
             --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
             --hostname=vnc-runner-$env:GITHUB_RUN_ID

          # Wait for Tailscale IP
          $ts=""
          for ($i=0; $i -lt 10; $i++) {
            $ts = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($ts) { break }
            Start-Sleep -Seconds 5
          }
          if (-not $ts) {
            Write-Error "Tailscale IP not found!"
            exit 1
          }

          echo "TS_IP=$ts" >> $env:GITHUB_ENV

      - name: Verify VNC Port
        run: |
          $result = Test-NetConnection -ComputerName $env:TS_IP -Port 5900
          if (-not $result.TcpTestSucceeded) {
            Write-Error "Port 5900 unreachable!"
            exit 1
          }

      - name: Show Connection Info
        run: |
          Write-Host "`n=== VNC ACCESS ==="
          Write-Host "IP Address: $env:TS_IP"
          Write-Host "Port: 5900"
          Write-Host "Password: $env:VNC_PASS"
          Write-Host "Viewer: TightVNC / RealVNC / UltraVNC"
          Write-Host "===================`n"

      - name: Keep Alive
        run: |
          while ($true) {
            Write-Host "[$(Get-Date)] VNC Alive"
            Start-Sleep -Seconds 300
          }
