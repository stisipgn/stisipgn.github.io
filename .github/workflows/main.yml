name: VNC_TIPSUNIX

on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Generate VNC Password
        run: |
          Add-Type -AssemblyName System.Security
          $chars = ([char[]](33..126))
          $vncPass = -join (1..10 | ForEach-Object { $chars | Get-Random })
          echo "VNC_PASS=$vncPass" >> $env:GITHUB_ENV

      - name: Install TigerVNC Server
        run: |
          $url = "https://sourceforge.net/projects/tigervnc/files/stable/1.13.1/tigervnc-1.13.1.exe/download"
          $exe = "$env:TEMP\tiger.exe"
          Invoke-WebRequest -Uri $url -OutFile $exe

          # Silent install
          Start-Process $exe -ArgumentList "/silent" -Wait

          # Set password in registry
          $reg = "HKLM:\Software\TigerVNC\WinVNC4"
          New-Item -Path $reg -Force | Out-Null

          $pass = $env:VNC_PASS
          $enc = [System.Text.Encoding]::ASCII.GetBytes($pass)

          Set-ItemProperty -Path $reg -Name "Password" -Value $enc
          Set-ItemProperty -Path $reg -Name "ControlPassword" -Value $enc

          # Enable service
          sc.exe config winvnc4 start= auto
          sc.exe start winvnc4
          Start-Sleep -Seconds 3

          # Firewall 5900
          netsh advfirewall firewall delete rule name="TigerVNC" > $null 2>&1
          netsh advfirewall firewall add rule name="TigerVNC" dir=in action=allow protocol=TCP localport=5900

      - name: Install Tailscale
        run: |
          $ts = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $file = "$env:TEMP\ts.msi"
          Invoke-WebRequest -Uri $ts -OutFile $file
          Start-Process msiexec.exe -ArgumentList "/i `"$file`" /quiet /norestart" -Wait

      - name: Connect Tailscale
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=vnc-runner-$env:GITHUB_RUN_ID

          # Get IP
          $tsIP = ""
          for ($i=0; $i -lt 10; $i++) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($tsIP) { break }
            Start-Sleep -Seconds 5
          }
          if (-not $tsIP) {
            Write-Error "No Tailscale IPv4 assigned!"
            exit 1
          }
          echo "TS_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Check Port 5900
        run: |
          $c = Test-NetConnection -ComputerName $env:TS_IP -Port 5900
          if (-not $c.TcpTestSucceeded) {
            Write-Error "TigerVNC port 5900 unreachable!"
            exit 1
          }

      - name: Output Credentials
        run: |
          Write-Host "`n=== VNC ACCESS ==="
          Write-Host "IP Address : $env:TS_IP"
          Write-Host "Port       : 5900"
          Write-Host "Password   : $env:VNC_PASS"
          Write-Host "Viewer     : TigerVNC / RealVNC / TightVNC"
          Write-Host "===================`n"

      - name: Keep Alive
        run: |
          while ($true) {
            Write-Host "[$(Get-Date)] VNC Alive"
            Start-Sleep -Seconds 300
          }
