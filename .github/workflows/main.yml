name: Linux_CRD_Tailscale_Remote

on:
  workflow_dispatch:

jobs:
  crd-remote:
    runs-on: ubuntu-latest
    timeout-minutes: 2000  # â‰ˆ33 jam aktif nonstop

    steps:
      - name: ğŸ§  System Info
        run: |
          echo "=== ğŸ§ System Info ==="
          lsb_release -a || cat /etc/os-release
          uname -a
          df -h
          echo "======================="

      # ğŸ–¥ï¸ Install Desktop + CRD dependencies
      - name: ğŸ§© Install XFCE + Chrome Remote Desktop
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            xfce4 xfce4-goodies \
            dbus-x11 x11-xserver-utils \
            wget curl sudo

          echo "â¬‡ï¸ Installing Chrome Remote Desktop..."
          wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo apt install -y ./chrome-remote-desktop_current_amd64.deb
          rm chrome-remote-desktop_current_amd64.deb

          echo "âœ… Chrome Remote Desktop installed!"

      # ğŸŒ Optional: install Google Chrome
      - name: ğŸŒ Install Google Chrome
        run: |
          echo "â¬‡ï¸ Installing Google Chrome browser..."
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb
          echo "âœ… Google Chrome installed!"

      # ğŸ‘¤ Create CRD User
      - name: ğŸ‘¤ Create User for Remote Desktop
        run: |
          echo "Creating CRD user..."
          sudo useradd -m crduser || true
          PASSWORD=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 8)
          echo "crduser:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo crduser
          echo "CRD_PASS=$PASSWORD" >> $GITHUB_ENV
          echo "âœ… User 'crduser' created with password: $PASSWORD"

      # ğŸ§© Setup Chrome Remote Desktop
      - name: ğŸ§© Configure Chrome Remote Desktop
        env:
          CRD_AUTH_CODE: ${{ secrets.CRD_AUTH_CODE }}
        run: |
          echo "ğŸ§  Configuring Chrome Remote Desktop..."
          sudo groupadd chrome-remote-desktop || true
          sudo usermod -a -G chrome-remote-desktop crduser
          sudo -u crduser bash -c "echo xfce4-session > ~/.chrome-remote-desktop-session"
          sudo systemctl disable lightdm.service || true

          if [ -z "$CRD_AUTH_CODE" ]; then
            echo "âš ï¸ Missing CRD_AUTH_CODE secret!"
            echo "Please generate from: https://remotedesktop.google.com/headless"
            exit 1
          fi

          echo "ğŸš€ Starting CRD host..."
          DISPLAY= /opt/google/chrome-remote-desktop/start-host \
            --code="$CRD_AUTH_CODE" \
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
            --name="GitHub-CRD-${{ github.run_id }}" &

          echo "âœ… CRD linked successfully!"

      # ğŸ”’ (Optional) Install and connect Tailscale
      - name: ğŸ”’ Setup Tailscale (Optional)
        if: ${{ secrets.TAILSCALE_AUTH_KEY != '' }}
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          echo "â¬‡ï¸ Installing Tailscale..."
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | \
            sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.tailscale-keyring.list | \
            sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt update && sudo apt install -y tailscale

          echo "ğŸš€ Starting Tailscale..."
          sudo tailscaled & sleep 5
          sudo tailscale up --authkey=${TS_AUTHKEY} --hostname=crd-${{ github.run_id }} --accept-dns=false
          TAILSCALE_IP=$(sudo tailscale ip -4 | head -n 1)
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "âœ… Connected to Tailscale: $TAILSCALE_IP"

      # ğŸ“‹ Show connection info
      - name: ğŸ“‹ Display Access Info
        run: |
          echo "=============================================="
          echo "ğŸ‰ Chrome Remote Desktop Setup Complete!"
          echo "Login with SAME Google Account you used to create the CRD auth code."
          echo "----------------------------------------------"
          echo "Username : crduser"
          echo "Password : $CRD_PASS"
          echo "Access   : https://remotedesktop.google.com/access"
          echo "----------------------------------------------"
          if [ -n "$TAILSCALE_IP" ]; then
            echo "ğŸ”— Optional Private Access via Tailscale:"
            echo "  SSH   : ssh crduser@$TAILSCALE_IP"
            echo "  IP    : $TAILSCALE_IP"
          fi
          echo "=============================================="

      # ğŸ’¤ Keep runner alive for GUI session
      - name: ğŸ’¤ Keep Alive
        run: |
          while true; do
            echo "[$(date)] ğŸŸ¢ CRD session active..."
            sleep 300
          done
