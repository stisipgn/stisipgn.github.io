name: Linux_GUI_Remote_Cloud

on:
  workflow_dispatch:

jobs:
  linux-vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 2000  # ğŸ•’ ~33 jam runtime

    steps:
      - name: Show System Info
        run: |
          echo "=== Ubuntu Info ==="
          lsb_release -a || cat /etc/os-release
          uname -a
          echo "==================="

      - name: Install XFCE Desktop + VNC Server
        run: |
          echo "ğŸ“¦ Installing XFCE desktop environment..."
          sudo apt-get update -y
          sudo apt-get install -y xfce4 xfce4-goodies tightvncserver dbus-x11
          
          echo "ğŸ§° Installing Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sh
          
          echo "ğŸ§¹ Cleaning apt cache..."
          sudo apt-get clean

      - name: Start Tailscale
        run: |
          echo "ğŸš€ Starting Tailscale daemon..."
          sudo tailscaled &

      - name: Connect to Tailscale
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sleep 5
          echo "ğŸ”— Connecting to Tailscale..."
          sudo tailscale up --authkey=${TS_AUTHKEY} --hostname=ubuntu-gh-${{ github.run_id }} --accept-dns=false
          echo "TAILSCALE_IP=$(tailscale ip -4)" >> $GITHUB_ENV
          echo "âœ… Connected to Tailscale!"

      - name: Setup VNC User
        run: |
          echo "ğŸ‘¤ Creating VNC user..."
          sudo useradd -m vncuser
          PASSWORD=$(openssl rand -base64 8)
          echo "vncuser:$PASSWORD" | sudo chpasswd
          echo "VNC_USER=vncuser" >> $GITHUB_ENV
          echo "VNC_PASS=$PASSWORD" >> $GITHUB_ENV

          echo "ğŸ“ Setting up VNC configuration..."
          sudo -u vncuser mkdir -p /home/vncuser/.vnc
          echo "xfce4-session &" | sudo tee /home/vncuser/.vnc/xstartup > /dev/null
          sudo chmod +x /home/vncuser/.vnc/xstartup

          echo "âœ… VNC user created."

      - name: Start VNC Server
        run: |
          echo "ğŸ–¥ï¸ Starting VNC server for user $VNC_USER..."
          sudo -u vncuser vncserver :1 -geometry 1280x800 -depth 24
          echo "âœ… VNC running on port 5901"

      - name: Firewall & Network Setup
        run: |
          echo "ğŸ”’ Opening VNC port..."
          sudo ufw allow 5901/tcp || true
          echo "âœ… Firewall updated."

      - name: Show Connection Info
        run: |
          echo "====================================="
          echo "ğŸ§ Linux GUI Remote is READY!"
          echo "Connect using any VNC viewer:"
          echo "Address : $TAILSCALE_IP:5901"
          echo "Username: $VNC_USER"
          echo "Password: $VNC_PASS"
          echo "====================================="
          echo "ğŸ’¡ On Windows: use RealVNC / TightVNC"
          echo "ğŸ’¡ On Linux : use Remmina / Vinagre"
          echo "ğŸ’¡ On macOS : Finder â†’ Go â†’ Connect to Server â†’ vnc://$TAILSCALE_IP:5901"
          echo "====================================="
          echo "ğŸ’¤ Keeping session alive..."
          for i in {1..400}; do
            echo "[$(date)] VNC active at $TAILSCALE_IP (iteration $i/400)"
            sleep 300
          done
