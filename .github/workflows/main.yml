name: Linux_CRD_Remote

on:
  workflow_dispatch:

jobs:
  crd:
    runs-on: ubuntu-latest
    timeout-minutes: 2000 

    steps:
      - name: System Info
        run: |
          echo "=== üêß System Info ==="
          lsb_release -a || cat /etc/os-release
          uname -a

      - name: Install XFCE + Chrome Remote Desktop
        run: |
          sudo apt update
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            xfce4 xfce4-goodies \
            dbus-x11 x11-xserver-utils \
            wget curl sudo

          echo "‚¨áÔ∏è Installing Chrome Remote Desktop..."
          wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo apt install -y ./chrome-remote-desktop_current_amd64.deb
          rm chrome-remote-desktop_current_amd64.deb

          echo "‚úÖ Chrome Remote Desktop installed!"

      - name: Install Google Chrome
        run: |
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb
          echo "‚úÖ Google Chrome installed!"

      - name: Create CRD User
        run: |
          echo "üë§ Creating CRD user..."
          sudo useradd -m crduser
          PASSWORD=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 8)
          echo "crduser:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo crduser
          echo "CRD_PASS=$PASSWORD" >> $GITHUB_ENV
          echo "‚úÖ User created with password: $PASSWORD"

      - name: Setup Chrome Remote Desktop
        env:
          CRD_AUTH_CODE: ${{ secrets.CRD_AUTH_CODE }}
        run: |
          echo "üß† Configuring Chrome Remote Desktop..."
          sudo usermod -a -G chrome-remote-desktop crduser
          sudo -u crduser bash -c "echo xfce4-session > ~/.chrome-remote-desktop-session"
          sudo systemctl disable lightdm.service || true

          if [ -z "$CRD_AUTH_CODE" ]; then
            echo "‚ö†Ô∏è Missing CRD_AUTH_CODE secret!"
            echo "Generate from https://remotedesktop.google.com/headless"
            exit 1
          fi

          # Jalankan CRD setup
          DISPLAY= /opt/google/chrome-remote-desktop/start-host \
            --code="$CRD_AUTH_CODE" \
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
            --name="GitHub-CRD-${{ github.run_id }}" &

          echo "‚úÖ CRD linked successfully!"

      - name: Access Info
        run: |
          echo "=============================================="
          echo "üéâ Chrome Remote Desktop Setup Complete!"
          echo "Login with the SAME Google account you used for setup."
          echo "----------------------------------------------"
          echo "Username : crduser"
          echo "Password : $CRD_PASS"
          echo "URL      : https://remotedesktop.google.com/access"
          echo "----------------------------------------------"
          echo "üí° Session will stay active for up to 2000 minutes."
          echo "=============================================="

      - name: Keep Alive
        run: |
          while true; do
            echo "[$(date)] üü¢ CRD Session Active"
            sleep 300
          done
