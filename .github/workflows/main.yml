name: VNC_TIPSUNIX

on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Generate VNC Password
        shell: pwsh
        run: |
          Add-Type -AssemblyName System.Security
          $chars = ([char[]](33..126))
          $vncPass = -join (1..10 | ForEach-Object { $chars | Get-Random })
          echo "VNC_PASS=$vncPass" >> $env:GITHUB_ENV

      - name: Install UltraVNC Server
        shell: pwsh
        run: |
          Write-Host "Downloading UltraVNC..."
          $url = "https://www.uvnc.eu/download/1450/UltraVNC_1450_x64_setup.exe"
          $exe = "$env:TEMP\uvnc.exe"
          Invoke-WebRequest -Uri $url -OutFile $exe

          Write-Host "Installing UltraVNC..."
          Start-Process $exe -ArgumentList "/verysilent" -Wait

          # UltraVNC password hash generation (8-byte DES)
          function Set-VNCPasswd {
              param (
                [parameter(Mandatory=$true)] [string]$Password,
                [parameter(Mandatory=$true)] [string]$RegPath
              )
              $passwd = [byte[]] (0..7 | % {0})
              $key = "UltraVNC"
              $s = $Password.Length
              if ($s -gt 8) { $Password = $Password.Substring(0,8) }
              for ($i=0; $i -lt $Password.Length; $i++) {
                  $passwd[$i] = [byte]([char]$Password[$i] -bxor 0xAA)
              }
              Set-ItemProperty -Path $RegPath -Name "passwd" -Value $passwd
          }

          $reg = "HKLM:\SOFTWARE\UltraVNC"
          New-Item -Path $reg -Force | Out-Null

          Set-VNCPasswd -Password $env:VNC_PASS -RegPath $reg

          # Start service
          sc.exe config uvnc_service start= auto
          sc.exe start uvnc_service
          Start-Sleep -Seconds 3

          # Open firewall
          netsh advfirewall firewall delete rule name="UltraVNC" > $null 2>&1
          netsh advfirewall firewall add rule name="UltraVNC" dir=in action=allow protocol=TCP localport=5900

      - name: Install Tailscale
        shell: pwsh
        run: |
          $ts = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $file = "$env:TEMP\ts.msi"
          Invoke-WebRequest -Uri $ts -OutFile $file
          Start-Process msiexec.exe -ArgumentList "/i `"$file`" /quiet /norestart" -Wait

      - name: Connect Tailscale
        shell: pwsh
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=vnc-runner-$env:GITHUB_RUN_ID

          $tsIP = ""
          for ($i=0; $i -lt 10; $i++) {
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($tsIP) { break }
            Start-Sleep -Seconds 5
          }
          if (-not $tsIP) { exit 1 }
          echo "TS_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Test Port 5900
        shell: pwsh
        run: |
          $c = Test-NetConnection -ComputerName $env:TS_IP -Port 5900
          if (-not $c.TcpTestSucceeded) { exit 1 }

      - name: Output VNC Info
        shell: pwsh
        run: |
          Write-Host "`n=== VNC ACCESS ==="
          Write-Host "IP Address : $env:TS_IP"
          Write-Host "Port       : 5900"
          Write-Host "Password   : $env:VNC_PASS"
          Write-Host "Viewer     : UltraVNC / RealVNC / TigerVNC"
          Write-Host "===================`n"

      - name: Keep Alive
        shell: pwsh
        run: |
          while ($true) {
            Write-Host "[$(Get-Date)] VNC Alive"
            Start-Sleep -Seconds 300
          }
