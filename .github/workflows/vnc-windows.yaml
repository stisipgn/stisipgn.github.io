name: VNC_WINDOWS

on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Generate Password
        shell: bash
        run: |
          PASS=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 12)
          echo "PASS=$PASS" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $msi = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $url -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /quiet /norestart" -Wait

      - name: Connect Tailscale
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=vnc-win-${{ github.run_id }}

          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TSIP=$ip" >> $env:GITHUB_ENV

      - name: Install TightVNC
        run: |
          $pass = $env:PASS

          # Direct stable link from SourceForge
          $url = "https://downloads.sourceforge.net/project/tightvnc/2.8.81/tightvnc-2.8.81-gpl-setup-64bit.msi"
          $msi = "$env:TEMP\tvnc.msi"

          Invoke-WebRequest -Uri $url -OutFile $msi
          Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /quiet /norestart" -Wait

          # TightVNC requires simple XOR encoding
          $xorKey = 0xAA
          $bytes = [System.Text.Encoding]::ASCII.GetBytes($pass)
          $encoded = ($bytes | ForEach-Object { $_ -bxor $xorKey })
          $hex = ($encoded | ForEach-Object { "{0:X2}" -f $_ }) -join ""

          New-Item -Path "HKLM:\SOFTWARE\TightVNC\Server" -Force | Out-Null
          Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "Password" -Value $hex
          Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "AcceptRfbConnections" -Value 1
          Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "AlwaysShared" -Value 1

          Start-Service tvnserver
          Set-Service tvnserver -StartupType Automatic

      - name: Output Access
        run: |
          Write-Host "=== WINDOWS VNC ==="
          Write-Host "IP: $env:TSIP:5900"
          Write-Host "Password: $env:PASS"

      - name: Keep Alive
        run: |
          while ($true) {
            Write-Host "Windows VNC active at $env:TSIP"
            Start-Sleep -Seconds 300
          }
